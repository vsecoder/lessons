
#### **4.1 Постановка задачи**

Мы создадим модуль, который:

1. Хранит город по умолчанию в базе данных.
    
2. Позволяет пользователю указать другой город при вызове команды.
    
3. Использует API `wttr.in` для получения текущей погоды.
    
4. Выводит информацию о погоде в удобном формате.
    

---

#### **4.2 Установка зависимостей**

Для работы с API `wttr.in` нам понадобится библиотека `requests`. Убедимся, что она установлена:

```bash
pip install requests
```

---

#### **4.3 Создание тестового файла**

Перед тем как писать модуль, создадим тестовый файл, чтобы понять, как работает API и какие данные оно возвращает. Это поможет избежать ошибок при разработке модуля.

---

#### **4.4 Тестовый файл**

Создадим файл `test_weather.py`:

```python
import requests

def get_weather(city: str) -> str | None:
    """Получает погоду для указанного города"""
    url = f"https://wttr.in/{city}?m&T&lang=ru"
    response = requests.get(url)
    if response.status_code == 200:
        return response.text
    return None

if __name__ == "__main__":
    city = input("Введите город: ")
    weather = get_weather(city)
    if weather:
        print(weather)
    else:
        print("Не удалось получить данные о погоде.")
```

---

#### **Что делает этот код:**

1. Функция `get_weather` отправляет запрос к API `wttr.in` и возвращает текст с информацией о погоде.
    
2. В основном блоке кода пользователь вводит город, и программа выводит погоду.
    

---

#### **4.5 Зачем нужен тестовый файл?**

1. **Понимание API**:
    
    - Мы видим, какие данные возвращает API и как их обрабатывать.
        
2. **Отладка**:
    
    - Легче находить и исправлять ошибки в изолированном коде.
        
3. **Экономия времени**:
    
    - Мы не тратим время на установку и перезагрузку модуля в Hikka для тестирования.
        

---

#### **4.6 Создание базовой структуры модуля**

Теперь создадим файл `weather_mod.py` и добавим базовую структуру модуля:

```python
from .. import loader, utils
import requests
import logging

logger = logging.getLogger(__name__)

@loader.tds
class WeatherMod(loader.Module):
    """Модуль для получения погоды"""

    strings = {"name": "WeatherMod"}

    def __init__(self):
        self.config = loader.ModuleConfig(
            "default_city",
            "Москва",  # Город по умолчанию
            "Город по умолчанию для получения погоды",
        )

    async def client_ready(self, client, db):
        self._client = client
        self._db = db

    async def weathercmd(self, message):
        """<город> - Получить погоду для указанного города"""
        args = utils.get_args_raw(message)
        city = args if args else self.config["default_city"]
        await utils.answer(message, f"Получаем погоду для города: {city}...")
```

---

#### **Что делает этот код:**

1. **Конфигурация**:
    
    - `default_city`: Город по умолчанию, который можно изменить через `.config`.
        
2. **Команда `weathercmd`**:
    
    - Если город указан в аргументах, используется он. Если нет — город из конфигурации.
        
    - Пока что модуль просто выводит сообщение о том, что погода для указанного города будет получена.
        

---

#### **4.7 Добавление логирования ошибок**

Добавим логирование, чтобы отслеживать ошибки:


```python
async def weathercmd(self, message):
    """<город> - Получить погоду для указанного города"""
    args = utils.get_args_raw(message)
    city = args if args else self.config["default_city"]

    try:
        url = f"https://wttr.in/{city}?m&T&lang=ru"
        response = requests.get(url)
        if response.status_code == 200:
            weather = response.text.splitlines()[:7]  # Берем первые 7 строк
            await utils.answer(message, f"<code>{'\\n'.join(weather)}</code>")
        else:
            await utils.answer(message, "Не удалось получить данные о погоде.")
            logger.error(f"Ошибка при запросе к API: {response.status_code}")
    except Exception as e:
        await utils.answer(message, "Произошла ошибка при получении погоды.")
        logger.error(f"Ошибка: {e}")
```

---

#### **Что делает этот код:**

1. **Логирование ошибок**:
    
    - Если запрос к API завершился ошибкой, она будет записана в лог.
        
2. **Форматирование ответа**:
    
    - Мы берем первые 7 строк ответа и выводим их в виде кода.
        

---

#### **4.8 Практическое задание**

1. Создайте тестовый файл `test_weather.py` и проверьте, как работает API.
    
2. Создайте модуль `weather_mod.py` и протестируйте его, установив в Hikka.
    
3. Добавьте логирование и проверьте, как оно работает при ошибках.
    

---

#### **4.9 Дополнительные улучшения**

1. **Inline-запросы**:
    
    - Добавьте поддержку inline-запросов, чтобы пользователи могли искать погоду прямо в чате.
        
2. **Кеширование данных**:
    
    - Добавьте кеширование, чтобы уменьшить количество запросов к API.
        
3. **Расширение функциональности**:
    
    - Добавьте возможность получать прогноз погоды на несколько дней.
        

---

#### **4.10 Дополнительные материалы**

- [Документация API wttr.in](https://wttr.in/:help)
    
- [Официальная документация Telethon](https://docs.telethon.dev/)
    
- [Примеры модулей для Hikka](https://github.com/hikariatama/Hikka)

**Отдельное спасибо каналу MoriSummerz, модуль погоды был написан по его примеру.**